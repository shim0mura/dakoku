#!/usr/bin/env ruby

require 'readline'

JOURNAL_HOME = File.expand_path("~") + "/.dakoku"
USAGE = <<HELP
  USAGE dakoku [options] what are you doing
  -h (--help)   show this help
  -l (--list)   show your journal of the selected day
  -a (--amend)  amend your journal of the selected line
  -c (--config) change reminder settings
HELP

#$LOAD_PATH.unshift File.expand_path("../lib", File.dirname(__FILE__))

class Dakoku
  def initialize
    now = Time.now
    check_dir(JOURNAL_HOME + "/#{now.year}/#{now.month}")
    @file = nil
    @now = Time.now
  end

  def journal(doing)
    set_file("a")
    @file.write(@now.to_s + ": " + doing + "\n")
    @file.close
  end

  def list(year = @now.year, month = @now.month)
    search_dir = JOURNAL_HOME + "/#{year}/#{month}/*"
    file_list = Dir.glob(search_dir)
    counter = puts_lists(file_list)
    puts "\n" + "-" * 20
    puts "\nselect line number you want to show.\n\n"
    begin
      while select = Readline.readline("line? > ", false)
        #next unless select.valid_selector?
        #break if File.exist?(file_list[select.to_s])
        #return list(@now.year, month-1) if select == "before" || select == "next"
        #return list(year, month) if select == "before" || select == "next"
        break if select
      end
    rescue
      exit!
    end
    #set_file(search_dir + filelist[select])
    set_file("r", file_list[select.to_i])
    puts_lists(@file.readlines)
    @file.close
  end

  def update
    set_file
    lines = @file.readlines
    if lines.empty?
      puts "You don't have journal to be update."
      exit!
    end

    counter = puts_lists(lines)
    puts "\n" + "-" * 20
    puts "\nselect line number you want to update.\n\n"
    input = get_input(0..counter-1)
    puts lines[select] unless lines[select].empty?

  end

  def remove

  end

  private
  def get_input(validate_range)
    begin
      while select = Readline.readline("line? > ", false)
        break if validate_range.include?(select)
        next puts "invalid input. select line number."
      end
    rescue
      exit!
    end
    select
  end
  #def getAround(year, month)
  #  date = DateTime.new(year, month)
  #  date.new_offset(Rational(9, 24))

  #  before_year = (date<<1).year
  #  before_month = (date<<).month
  #  next_year = (date>>1).year
  #  next_month = (date>>1).month
  #  return if check_dir(JOURNAL_HOME + "/#{year}/#{month}")
  #end

  def check_dir(path)
    return true if File.exist?(path)
    check_dir(File.dirname(path), mkdir?)
    Dir.mkdir(path)
  end

  def set_file(type, filename = nil)
    unless filename
      filename = JOURNAL_HOME + "/#{@now.year}/#{@now.month}/#{@now.strftime('%Y%m%d')}.dat"
    end
    @file = open(filename, type)
  end

  def puts_lists(lists)
    counter = 0
    puts "\n"
    lists.each do |line|
      puts "[#{counter}]  " + line
      counter += 1
    end
    counter
  end

end

dakoku = Dakoku.new

case ARGV[0]
when "-h", "--help", nil
  puts USAGE
when "-l", "--list"
  dakoku.list
else
  dakoku.journal(ARGV[0])
end
